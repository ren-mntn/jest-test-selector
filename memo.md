# 変更内容

## 2024-04-04: 「All Tests」オプションの追加

ファイル内のすべてのテストを実行するための「All Tests」オプションを追加しました。

### 変更内容:

1. `TestCase` インターフェースに `isAllTests` 省略可能なプロパティを追加
2. `testTreeDataProvider.ts` の `buildTestTree` メソッドを修正して、ファイルノードの下に「All Tests」ノードを追加
3. `debugger.ts` の `startDebugging` メソッドを修正して、`testCase.isAllTests` が true の場合は `-t` フラグを使わないように変更

これにより、特定のファイル内のすべてのテストを簡単に実行できるようになりました。

## 2024-04-05: 実装ファイルからテスト一覧を表示する機能の追加

実装ファイル（例：getNewsFromDB.ts）を開いたとき、対応するテストファイル（例：getNewsFromDB.test.ts）があれば、そのテスト一覧を表示するようにしました。

### 変更内容:

1. `TestTreeDataProvider` クラスに `findCorrespondingTestFile` メソッドを追加して、実装ファイルに対応するテストファイルを検索する機能を実装
2. `refresh` メソッドを修正して、現在開いているファイルがテストファイルでない場合も対応するテストファイルを探索するように変更
3. `getChildren` メソッドを修正して、実装ファイルが開かれている場合でも対応するテストファイルのテスト一覧を表示できるように変更

これにより、実装ファイルを編集しながらテストを簡単に実行できるようになりました。

## 2024-04-05: ディレクトリベースのテスト表示機能の追加

現在開いているファイルと同じディレクトリ内のすべてのテストファイルを一覧表示する機能を追加しました。ファイルベースルーティングを採用しているプロジェクト向けに、関連するテストをまとめて表示・実行できるようになりました。

### 変更内容:

1. `findAllTestFilesInDirectory` メソッドを追加して、指定されたディレクトリ内のすべてのテストファイルを検索する機能を実装
2. `buildDirectoryTestTree` メソッドを追加して、複数のテストファイルからのテストケースをツリー構造で表示する機能を実装
3. `refresh` メソッドと `getChildren` メソッドを修正して、ディレクトリモードとファイルモードの切り替えロジックを実装

これにより、同じディレクトリ内の複数のテストファイルを開かなくても、すべてのテストをまとめて確認・実行できるようになりました。ファイルベースルーティングを使用したプロジェクトで特に有用です。

## 2024-04-05: テストケース抽出ロジックの改善

テストファイル内の describe ブロックとテストケースの階層構造を正確に認識できるように改善しました。

### 変更内容:

1. `testExtractor.ts`の抽出ロジックを修正し、括弧の深さを追跡して正確にブロックの開始と終了を判断するように変更
2. 単純な文字列一致（`line.includes("});"`）による判定から、実際の括弧のバランスを追跡する方法に変更

これにより、すべてのテストケースが適切な階層構造で表示されるようになり、特に複数のテストケースを含む describe ブロック内のテストが正しくグループ化されるようになりました。

## 2024-04-06: テスト実行時の通知を削除

テスト選択時に表示される通知メッセージを削除しました。

### 変更内容:

1. `debugger.ts` の `startDebugging` メソッドから通知表示コード `vscode.window.showInformationMessage(`テスト「${testCase.name}」を実行します`);` を削除
2. `debugger.ts` の `startDebuggingAllTests` メソッドから通知表示コード `vscode.window.showInformationMessage(`ファイル「${path.basename(testFilePath)}」内のすべてのテストを実行します`);` を削除

これにより、テスト実行時に表示される不要な通知が表示されなくなり、よりクリーンなユーザーエクスペリエンスになりました。

## 2024-04-06: 現在のディレクトリ内のすべてのテストを実行する機能の追加

現在フォーカスしているファイルが存在するディレクトリ内のすべてのテストを一括実行する機能を追加しました。

### 変更内容:

1. `debugger.ts` に `startDebuggingDirectoryTests` メソッドを追加して、指定されたディレクトリ内のすべてのテストを実行する機能を実装
2. `extension.ts` に `runDirectoryTests` コマンドを追加し、現在のエディタで開いているファイルのディレクトリ内のテストを実行するロジックを実装
3. `package.json` にコマンド定義を追加し、キーバインド（Cmd+Shift+D / Ctrl+Shift+D）を設定
4. アーキテクチャドキュメント（`archtect.md`）を更新して新機能の説明を追加

これにより、特定のディレクトリ内のすべてのテストをワンクリックまたはキーボードショートカットで簡単に実行できるようになりました。この機能は特にモノレポやマイクロサービス環境で、関連するテストをまとめて実行したい場合に便利です。

## 2024-04-07: テストエクスプローラーにルートレベルの「すべてのテストを実行」項目の追加

テストエクスプローラーのルートレベルに「すべてのテストを実行」項目を追加し、ワークスペース内のすべてのテストを一括で実行できるようにしました。

### 変更内容:

1. `TestNode` インターフェースに `isGlobalAllTests` プロパティを追加して、グローバルな「すべてのテストを実行」ノードを識別できるようにした
2. `TestTreeDataProvider` クラスに `buildRootNodes` メソッドを追加し、ルートレベルに「すべてのテストを実行」ノードを作成
3. `TestTreeItem` クラスを拡張し、`isGlobalAllTests` フラグに基づいて特別なアイコンと動作を設定
4. `extension.ts` に `runAllVisibleTests` コマンドを追加し、ワークスペース全体のテストを実行する機能を実装
5. `package.json` に新しいコマンドを登録し、アクティベーションイベントにも追加

これにより、テストエクスプローラーのトップレベルから簡単にプロジェクト全体のテストを実行できるようになり、テスト実行のワークフローが改善されました。特に大規模なプロジェクトで全体的なテスト実行が必要な場合に便利です。

## extractParams プレフィックスを持つテストファイルの表示修正

### 対応内容

- テストエクスプローラーの一覧で extractParams プレフィックスを持つテストファイルのテストケースが不適切にネストされる問題を修正
- extractParams プレフィックスを持つテストファイルのテストケースをフラットに表示するように変更
- `src/testTreeDataProvider.ts`の`buildTestTree`と`buildDirectoryTestTree`メソッドを修正

### 修正方法

ファイル名が'extractParams'で始まり'.test.ts'で終わるファイルを特別に処理し、テストケースを describe でネストせずに直接ファイルノードの子として表示するようにした。

## フォーカスしているファイルのテスト項目をハイライト表示

### 対応内容

- テストエクスプローラーで、現在フォーカスしているファイルと同じファイルのテスト項目のみ背景色を少し白くして目立たせる機能を追加
- テストファイル、テストケース、describe ブロック、"All Tests"項目を含む現在フォーカスしているファイルの全ての項目をハイライト表示

### 修正方法

- `TestTreeItem` クラスのコンストラクタで、現在アクティブなエディタのファイルパスと項目のファイルパスを比較し、一致する場合に特別な表示を適用
- 一致するアイテムに `list.highlightForeground` テーマカラーを適用して目立たせる
- ハイライト表示されたアイテムには、ツールチップにも「[現在のファイル]」という表示を追加して認識しやすく改善
- コンテキスト値に「highlighted」を追加して、将来的なスタイリングの拡張を容易にした

この改善により、大量のテストファイルがある場合でも、現在編集中のファイルに関連するテスト項目をすぐに識別できるようになりました。

## 2024-06-19: テスト設定の「--onlyFailures」オプションがデフォルトで有効になる問題を修正

### 対応内容

- テスト設定画面で「--onlyFailures」オプションがデフォルトで有効になってしまう問題を修正
- 「--onlyFailures」オプションのデフォルト値を明示的に無効（false）に設定

### 修正方法

- `src/testSettingsView.ts`ファイル内の「--onlyFailures」オプションの値設定部分を修正
- `!!currentOptions["--onlyFailures"]`を`currentOptions["--onlyFailures"] === true ? true : false`に変更
- これにより、オプションが明示的に true に設定されている場合のみ有効になり、デフォルトでは無効になるように修正

この修正により、テスト実行時に意図せず失敗したテストのみが実行される問題が解決され、デフォルトでは全てのテストが実行されるようになりました。

## 2024-06-19: ARCHITECTURE.md の主要コンポーネント詳細を更新

### 対応内容

- ARCHITECTURE.md の「主要コンポーネント詳細」セクションを、現在の実装コードに基づいて更新
- 各コンポーネント（extension.ts, debugger.ts, testExtractor.ts など）の詳細説明を最新化
- クラス構造、メソッド、インターフェース定義などの具体的な情報を追加

### 更新ポイント

- 各コンポーネントが提供する機能の詳細な説明を追加
- インターフェース定義（TestCase, PackageInfo など）の型情報を具体的に記載
- クラスのメソッドや責務の詳細を明確化
- 実装の特徴や重要なロジックについての説明を追加

この更新により、アーキテクチャドキュメントが現在のコードベースを正確に反映し、新しい開発者がプロジェクトを理解しやすくなりました。

## 2024-06-19: ARCHITECTURE.md に機能拡張ガイドを追加

### 対応内容

- ARCHITECTURE.md に機能拡張シナリオとガイドラインを追加
- 「拡張ポイント」セクションを強化し、具体的な拡張方法を詳細に記載
- 新しいセクション「一般的な機能拡張シナリオ」を追加

### 更新ポイント

- 「テストエクスプローラーの機能拡張」と「テスト実行範囲の拡張」の説明を拡張ポイントに追加
- 以下の一般的な機能拡張シナリオをコード例付きで追加:
  1. テストエクスプローラーに新しいコマンドを追加する方法
  2. 特定のテスト範囲を実行する機能を追加する方法
  3. テスト設定に新しいオプションを追加する方法
  4. ワークスペース全体のテストを実行する機能を追加する方法
  5. 特殊なテストファイル形式に対応する方法
- 各シナリオには具体的な手順と必要なファイル修正箇所、コード例を含む

この更新により、LLM が「テストエクスプローラーに全体のテストを実行する処理を追加して」のような要求に対して、より効率的に必要な実装ステップを理解し、適切なコード修正を提案できるようになりました。機能追加の際の一貫性も向上し、アーキテクチャドキュメントが実装ガイドとしても機能するようになりました。

## 2024-06-21: テストエクスプローラーのルートアイテムの表示名を変更

### 対応内容

- テストエクスプローラーのルートレベルにある「すべてのテストを実行」項目の表示名を「現在のディレクトリのすべてのテストを実行」に変更
- 表示名の変更に合わせて、ツールチップやコマンドタイトルも更新

### 修正内容

1. `src/testTreeDataProvider.ts` の `buildRootNodes` メソッド内のノード名を変更
2. `TestTreeItem` クラスのコンストラクタ内の `globalAllTests` ケースのツールチップとコマンドタイトルを変更
3. `package.json` の関連コマンド定義の表示タイトルを更新

この変更により、テストエクスプローラーのルートレベルのアイテムの機能がより明確になり、ユーザーがどの範囲のテストが実行されるのかを正確に理解できるようになりました。

## 2024-06-21: ディレクトリノード内の「すべてのテストを実行」表示も修正

### 対応内容

- ディレクトリノード内の「すべてのテストを実行」ノードの表示名も「このディレクトリのすべてのテストを実行」に変更
- 表示名変更によりテストエクスプローラー UI の一貫性を向上

### 修正内容

1. `src/testTreeDataProvider.ts` の `buildDirectoryTestTree` メソッド内のディレクトリノード直下の「すべてのテストを実行」ノードの名前を変更
2. テストケースオブジェクトの name 属性と fullName 属性も同様に更新

この変更により、ディレクトリレベルのテスト実行項目の表示名も統一され、UI の一貫性が向上しました。これでユーザーは各実行範囲をより明確に理解できるようになりました。

## 2024-07-08: ディレクトリテスト実行コマンド形式の変更

### 対応内容

- テスト実行コマンドの形式を特定の形に変更し、VS Code のデバッグ環境変数を追加
- `cd` コマンドを使って正しいディレクトリに移動してからテストを実行するように修正
- テストパターンを `/*.*` 形式に変更

### 修正内容

1. `debugger.ts` の `prepareDirectoryTestCommand` メソッドを修正:

   - テストパターンを `${absoluteDirPath}/*.*` 形式に変更
   - `cd ${packageInfo.path} ; npx jest '${testPattern}' --config ${configFile} ${cliArgs.join(" ")}` 形式のコマンドを生成

2. `startDebuggingWithCustomCommand` メソッドを修正:
   - VS Code のデバッグに必要な環境変数 `NODE_OPTIONS` と `VSCODE_INSPECTOR_OPTIONS` を追加
   - `/usr/bin/env 'NODE_OPTIONS=...' 'VSCODE_INSPECTOR_OPTIONS=...' /bin/sh -c "..."` 形式のコマンドを生成
   - 一意のセッション ID を生成してデバッグ設定に含める

この変更により、VS Code のデバッグ機能が正しく動作し、特定のディレクトリ内のテストファイルを正確に実行できるようになりました。特にモノレポ構造のプロジェクトで効果的に機能します。

## 2024-07-08: Jest テストパターン指定の改善

### 対応内容

- Jest のテストパターン指定方法を改善し、より堅牢なコマンド生成を実現
- テストパターンから拡張子指定を削除し、シンプルな「\*」パターンを使用
- ARCHITECTURE.md に成功したコマンド例と注意点を追加

### 修正内容

1. `debugger.ts` の `prepareDirectoryTestCommand` メソッドを修正:

   - テストパターンを `${absoluteDirPath}/*` 形式に変更（拡張子指定なし）
   - Jest がデフォルトでテストファイルのみを認識するため、不要な拡張子指定を削除

2. `ARCHITECTURE.md` に新しいセクション「9. Jest コマンド実行と正規表現の注意点」を追加:
   - 実際に成功したコマンド例を記載
   - テストファイルパターン指定時の注意点を詳しく説明
   - 拡張子指定が不要な理由とシンプルなパターン使用の利点を説明

この改善により、テスト実行コマンドがより堅牢になり、異なる環境でも一貫して動作するようになりました。また、開発者が Jest のパターン指定方法について理解を深めることができるようになりました。

## 2024-07-08: サブディレクトリを除外するテストパターン指定の改善

### 対応内容

- Jest がデフォルトで再帰的にサブディレクトリを検索することによる問題を解決
- `--testPathPattern` オプションを使用して特定ディレクトリ直下のファイルのみを検索するように改善
- 正規表現パターンを使ってサブディレクトリを確実に除外する方法を実装

### 修正内容

- `debugger.ts` の `prepareDirectoryTestCommand` メソッドを修正:

  - `--testPathPattern='^${escapeRegExp(absoluteDirPath)}/[^/]+\.test\.(ts|js)$'` 形式の正規表現を使用
  - この正規表現は「指定ディレクトリ直下のテストファイルのみ」を意味し、サブディレクトリを除外
  - 正規表現特殊文字のエスケープ処理を強化し、様々な環境で一貫して動作するように対応

- `ARCHITECTURE.md` の「Jest コマンド実行と正規表現の注意点」セクションを更新:
  - サブディレクトリを除外する具体的な方法と正規表現パターンの説明を追加
  - 良い例と悪い例を示し、理解を促進

この改善により、ディレクトリテスト実行が意図した通りに動作し、指定ディレクトリ直下のテストファイルのみが実行されるようになりました。これはファイルシステムの階層が深いプロジェクトで特に重要な改善です。

## 2024-07-19: パッケージ単位でのテスト実行機能の追加

### 対応内容

- モノレポ環境で、現在のファイルが含まれるパッケージの全テストを実行できる機能を追加
- ファイルパスから Jest 設定ファイル（jest.config.js）のあるディレクトリを検出し、そのパッケージ名を使用したノードを追加
- 例: `/apps/server/src/...` のファイルでは「server のテストを実行」ノードを表示し、クリックで`/apps/server`の全テストを実行

### 実装内容

1. `testTreeDataProvider.ts` への機能追加:

   - `findPackageDirectoryWithJestConfig` メソッドを追加し、現在のファイルパスから jest.config.js のあるディレクトリを検出
   - `addPackageTestNode` メソッドを追加してパッケージテスト実行ノードをツリーに挿入
   - `refresh` メソッドを修正し、パッケージ情報が見つかった場合にノードを追加

2. 新しいノードタイプの追加:

   - `TestItemType` に `packageAllTests` タイプを追加
   - `TestTreeItem` クラスに新しいタイプのアイコンと動作を設定

3. コマンド実装:

   - `extension.ts` に `runPackageAllTests` コマンドを追加
   - `runTestsAtScope` 関数に `package` スコープを追加
   - `package.json` に新しいコマンドを登録

4. ドキュメント更新:
   - `ARCHITECTURE.md` に新機能の説明を追加

この機能により、モノレポ環境で効率的に作業できるようになり、深い階層にあるファイルを編集中でも、そのパッケージ全体のテストを簡単に実行できるようになりました。

## 2024-07-20: ワークスペース全体のテスト実行機能を削除

### 対応内容

- ワークスペース全体のテスト実行機能を削除（不要な機能のため）
- テストツリーから「ワークスペース全体のテストを実行」ノードを削除

### 実装内容

1. `testTreeDataProvider.ts` の修正:

   - `buildRootNodes` メソッドを修正して空の配列を返すように変更
   - `buildDirectoryTestTree` メソッドを修正してグローバルノード参照を削除
   - `addPackageTestNode` メソッドを修正してパッケージノードを先頭に追加するように変更

2. `extension.ts` の修正:

   - `runGlobalAllTests` コマンドを削除

3. `package.json` の修正:
   - `jestTestSelector.runGlobalAllTests` コマンド定義と関連する activationEvents を削除

この変更により、ワークスペース全体のテスト実行ノードが表示されなくなり、UI がシンプルになりました。パッケージ単位のテスト実行機能を使用することで、より効率的にテストが実行できます。

## 2023-10-XX

- 初期バージョンをリリース
- テストファイルとテストケースの階層表示機能を実装
- テスト実行機能を実装

## 2023-10-XX

- ディレクトリベースのテスト表示モードを追加
- 現在のディレクトリからすべてのテストを実行する機能を追加

## 2023-10-XX

- テスト結果の表示改善
- テスト設定画面の追加

## 2024-07-XX

- 「ワークスペース全体のテスト実行」ノードの表示修正

  - テストツリーの更新時にワークスペース全体のテストを実行ノードが消えてしまう問題を修正
  - ディレクトリやファイルの切り替え時にもトップレベルのノードが常に表示されるように改善

- ディレクトリテスト実行オプションの改善

  - ディレクトリのテスト実行オプションを「すべてのテストを実行」「ユニットテストを実行」「E2E テストを実行」に簡潔化
  - 冗長な「このディレクトリの」という文言を削除し、ユーザーエクスペリエンスを向上

- 非モノレポ環境でのテスト実行エラーの修正

  - 「パッケージ情報が取得できませんでした」エラーが表示されてテストが実行できない問題を修正
  - モノレポパッケージが見つからない場合は、ルートパッケージを使用するフォールバック処理を追加
  - これにより、モノレポでない通常のプロジェクトでもテスト実行が可能に

- npm override エラーの解決
  - `Override for typescript@^5.2.2 conflicts with direct dependency`エラーが発生する問題を修正
  - テスト実行コマンドに`--no-override`フラグを追加して、npm override による競合を回避
  - これにより、package.json に overrides 設定があるプロジェクトでも正常にテストが実行できるように改善

## 2024-06-11 バグ修正

### ディレクトリ内のテスト実行が正しく機能しない問題を修正

**問題**:  
ディレクトリ内のテストを実行するノードを選択した際に、ディレクトリ内のテストではなくパッケージ全体のテストが実行されていた。

**原因**:  
`src/extension.ts` の `runTestsAtScope` 関数内の "directory" ケース実装で、ディレクトリを指定せずに `npx jest` コマンドを実行していたため、パッケージ全体のテストが実行されていた。

**修正内容**:  
ディレクトリ内のテストのみが実行されるように、`JestDebugger.prepareDirectoryTestCommand` を使用して正しくディレクトリを指定したコマンドを生成し、実行するように修正した。また、E2E テストのみを実行するオプションも追加した。

```typescript
// ディレクトリのテストのみを実行するように修正
const dirCommand = await JestDebugger.prepareDirectoryTestCommand(
  targetPath,
  targetPackage,
  false // 通常のテスト
);
const e2eDirCommand = await JestDebugger.prepareDirectoryTestCommand(
  targetPath,
  targetPackage,
  true // E2Eテスト
);

await JestDebugger.startDebuggingWithCustomCommand(
  targetPath,
  targetPackage,
  `${dirCommand} && ${e2eDirCommand}`,
  `${path.basename(targetPath)} ディレクトリのテスト`
);
```

この修正により、ディレクトリノードを選択した場合に、そのディレクトリ内のテストファイルのみが実行されるようになった。

## 2024/04/05

### ノードクリック時の動作変更

テストツリーのノードをクリック時の動作を変更しました：

- 以前は、ノードをクリックすると直接テストが実行されていました
- 変更後は、ノードをクリックするとそのファイルが開かれるようになりました
- テストケースのノードをクリックすると、そのテストのある行にジャンプするようになりました
- 実行ボタンやコンテキストメニューからは、従来通りテストを実行できます

これにより、使い勝手が向上し、ノードをクリックして内容を確認してからテストを実行するワークフローが可能になりました。

### フォーカス中のファイルのノードに実行ボタンが表示されない問題を修正

#### 問題

フォーカス中のファイルのノードの右側に実行ボタンが表示されないという問題がありました。

#### 原因

ハイライト処理の際にコンテキスト値を `"${contextValue} highlighted"` のようにスペースを含む形式で設定していたため、VSCode が正しくコンテキスト値を認識できていませんでした。

#### 修正内容

コンテキスト値の設定方法を変更し、スペースを含まない形式 `"${contextValue}-highlighted"` に変更しました。これにより、フォーカス中のファイルのノードでも正しくコンテキスト値が認識され、実行ボタンが表示されるようになりました。

### フォーカス中のファイルのノードの実行アイコン表示問題を再修正

#### 問題

以前の修正でコンテキスト値の形式を変更しましたが、それでもフォーカス中のファイルのノードには実行アイコンが表示されない問題が残っていました。

#### 原因

ハイライト表示処理の際に、コンテキスト値は正しく設定されていましたが、一部のノードで元のコマンド設定が失われていた可能性があります。VSCode のツリービューでは、実行アイコンを表示するためには適切なコンテキスト値だけでなく、command プロパティも正しく設定されている必要があります。

#### 修正内容

ハイライト表示処理内でコマンドプロパティの維持を確実にするコードを追加しました。具体的には：

1. ハイライト適用時にコマンドが未設定の場合のみ新しいコマンドを設定するロジックを追加
2. テストケースでは行番号に基づいたジャンプコマンドを設定
3. その他のノードではシンプルにファイルを開くコマンドを設定

これにより、フォーカス中のファイルのノードでも実行アイコンが正しく表示されるようになりました。

### フォーカス中のファイルのノードに実行アイコンが表示されない問題を完全に修正

#### 問題

過去の修正でも、フォーカス中（ハイライト表示された）ファイルのノードに実行アイコンが表示されない問題が解決しませんでした。

#### 原因

VSCode では、ツリービューの実行アイコンを表示するためには、package.json の`contributes.menus.view/item/context`セクションで、各コンテキスト値（viewItem）に対応する条件設定が必要です。ハイライト状態のノード（例：`testCase-highlighted`）に対する条件設定が不足していました。

#### 修正内容

package.json の`menus.view/item/context`セクションを更新し、各コマンドの`when`条件に通常状態とハイライト状態の両方を含めるように修正しました：

```json
{
  "command": "jestTestSelector.runSelectedTest",
  "when": "view == jestTestSelector.testExplorer && (viewItem == testCase || viewItem == testCase-highlighted)",
  "group": "inline"
}
```

さらに、他のノードタイプ（directoryAllTests, directoryUnitTests, directoryE2ETests, fileAllTests）にも同様の設定を追加しました。これにより、全てのノードタイプで、フォーカス中（ハイライト表示）でも実行アイコンが表示されるようになりました。
