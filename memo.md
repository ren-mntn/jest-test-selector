# Jest テスト結果に基づくアイコン表示の実装アプローチ

JestTestSelector 拡張機能でテスト結果に基づいてテストケースのアイコンの色を変更するためのアプローチを検討します。

## 実装アプローチの比較

以下の方法が考えられます：

### 1. Jest JSON レポーターを利用する方法

- **概要**: Jest に`--json`フラグを追加して実行し、JSON 形式のテスト結果を取得
- **メリット**: 構造化されたデータで扱いやすい、Jest 公式の API を使用
- **デメリット**: 別プロセスで実行する必要あり、JSON データが大きくなる可能性

### 2. カスタム Jest レポーターを作成する方法

- **概要**: Jest 用のカスタムレポーターを作成して結果をファイルに出力
- **メリット**: 必要な情報だけを取得可能、柔軟なフォーマット
- **デメリット**: 設定が複雑、ユーザー側で追加設定が必要になる可能性

### 3. ターミナル出力のパース

- **概要**: すでに実装されているデバッグターミナルからの出力をキャプチャして解析
- **メリット**: 既存のコードを活用できる、追加の設定不要
- **デメリット**: テキスト解析は壊れやすい、Jest 出力形式が変わると影響を受ける

### 4. Jest API の直接使用

- **概要**: Jest Node API を直接使用してテスト実行と結果取得を行う
- **メリット**: 最も直接的なアプローチ、信頼性が高い
- **デメリット**: API の変更に影響を受ける可能性、依存関係が増える

## 公式ドキュメント確認結果

### JSON レポーター

公式ドキュメントの「[Jest CLI Options](https://jestjs.io/docs/cli)」によると：

> `--json` - Prints the test results in JSON. This mode will send all other test output and user messages to stderr.

これにより、標準出力に JSON 形式のテスト結果が出力されることが確認できます。

### カスタムレポーター

[Custom Reporters](https://jestjs.io/docs/configuration#reporters-arraymodulename--modulename-options) の公式ドキュメントによると、Jest は独自のレポーターをサポートしています：

```js
// jest.config.js
module.exports = {
  reporters: ["default", "<カスタムレポーターのパス>"],
};
```

### Jest API

公式の[Jest Programmatic API](https://jestjs.io/docs/api)によると、NodeJS 内で Jest を直接実行することができます：

```js
const { runCLI } = require("@jest/core");

// Jestを実行して結果を取得
const results = await runCLI({ json: true }, [projectRootPath]);
```

## 推奨アプローチ

実装の複雑さとメンテナンス性を考慮して、以下の順で推奨します：

1. **ターミナル出力のパース** - 既存のコードを活用でき、最も早く実装可能。現在のコードベースではすでにターミナル出力をキャプチャする機能がある。

2. **JSON レポーター** - 構造化されたデータを取得できるため信頼性が高い。別プロセスで Jest を実行し、結果を保存して読み込む方法が実装しやすい。

3. **Jest API 直接使用** - 最も柔軟だが、依存関係と実装の複雑さが増す。

## 実装案

### ターミナル出力パース方式

1. `JestDebugger` クラスで既存の `setupTerminalOutputCapture` メソッドを拡張し、テスト結果を抽出する機能を追加
2. テスト名とその結果（成功/失敗）のマッピングを保持するストレージを作成
3. `TestTreeDataProvider` にテスト結果を反映するためのメソッドを追加
4. `TestTreeItem` クラスでテスト結果に基づいて異なるアイコンを表示するよう変更

具体的な実装には、以下の正規表現パターンでパース可能：

- 成功テスト: `✓ テスト名`
- 失敗テスト: `✕ テスト名`

このアプローチは、既存のコードに最小限の変更で統合でき、ユーザー側の追加設定も不要です。

## 実装結果

**ターミナル出力パース方式**で実装を完了しました。以下の機能が追加されました：

### 1. テスト結果の収集

- `JestDebugger` クラスに、テスト結果をキャプチャしてパースする機能を追加
- テスト結果の状態として`Success`、`Failure`、`Unknown`、`Running`を定義
- テスト実行時にリアルタイムでテスト結果をキャプチャし、内部マップに保存

### 2. テスト結果の表示

- `TestTreeItem` クラスに、テスト結果に基づいてアイコンを変更する機能を追加
  - 成功：緑色のチェックマークアイコン
  - 失敗：赤色のエラーアイコン
  - 実行中：青色の再生アイコン

### 3. リアルタイム更新

- テスト出力イベントとテストセッション終了イベントを追加
- これらのイベントをリッスンして`TestTreeDataProvider`がツリービューを更新するよう実装

### 使用方法

これらの変更により、テストを実行した後、テストエクスプローラーのツリービューに各テストの結果がアイコンの色で表示されます。テスト結果は次のテスト実行まで保持されます。

### 技術的詳細

1. **テスト結果の保存**：`JestDebugger.testResults` Map でキー`ファイルパス#テスト名`、値`TestResultInfo`として保存
2. **出力解析**：正規表現 `/✓\s+(.+)$/gm` と `/✕\s+(.+)$/gm` でテスト結果をキャプチャ
3. **アイコン設定**：VSCode の ThemeColor と ThemeIcon を使用して状態に応じたアイコンを表示
4. **ステータス更新**：イベントエミッターを使用してテスト実行状態の変化を通知

## 2023.5.11

- テスト実行時にファイルパスが正しく検出されない問題を修正

  - Jest 出力の複数パターンに対応するよう改善
  - テストファイルパス検出ロジックを強化 (複数のパターンを試行)
  - 成功/失敗テスト検出の正規表現を拡張
  - テスト出力がない場合の自動検出機能を追加
  - パス検証機能の追加で無効なパスを除外

- `String.prototype.matchAll()`のエラーを修正

  - すべての正規表現パターンにグローバルフラグ(`g`)を追加
  - テキスト解析時の検索パターンを修正
  - 構文エラーの修正: `matchAll()`は非グローバル正規表現では使用不可

- JSON 形式のテスト結果を直接解析する機能を追加
  - `--json`フラグを使用した Jest 実行時の JSON データを検出
  - テストファイル名とテスト名を JSON から直接取得
  - 従来の正規表現ベースのパース機能はフォールバックとして維持
  - より正確なテスト結果の検出率を向上

## 2023.5.12

- JSON 形式のテスト結果パース機能を大幅に改善

  - テストファイルパス検証ロジックを強化（`.e2e.test.ts`などの形式に対応）
  - 複数のパスフォーマットに対応（絶対パス・相対パス・ファイル名のみ）
  - パス正規化処理の追加で Windows/Unix パスの差異を吸収
  - 処理コードをより再利用可能な構造にリファクタリング

- デバッグセッション処理を強化

  - タイムアウト時間を 30 秒から 60 秒に延長
  - タイムアウト発生時に最終的な JSON 結果解析を行う機能を追加
  - Channel closed エラーを防止するセッション終了処理の改善

- JSON 解析の信頼性向上
  - 複数の JSON 構造パターンに対応
  - 出力全体から JSON データを抽出する機能を追加
  - パス取得方法を複数用意して冗長性を確保

## 2023.5.13

- テスト結果ファイル出力機能の追加

  - `--outputFile`オプションを使用して JSON ファイルに直接テスト結果を出力
  - 一時ディレクトリに`jest-results-{timestamp}.json`形式でファイルを生成
  - ファイルから JSON データを読み込むことで標準出力の解析に依存しない構造に変更

- デバッグセッション終了処理の改善

  - セッション終了時にファイルからテスト結果を自動的に読み込む機能を実装
  - ファイル読み込みに失敗した場合は従来の方法へフォールバック
  - VSCode デバッグセッション終了イベントの監視による確実な終了処理

- 安定性向上の工夫
  - ファイル生成を待機する機能（最大 10 秒）
  - チャンネルクローズの問題を回避
  - テスト結果取得の信頼性向上

## 2023.5.14

- テスト結果ファイルの読み込み処理を強化

  - ファイル読み込み時のエラー処理を大幅に改善
  - JSON データ解析失敗時のファイル内容のデバッグ出力機能を追加
  - ファイル完全書き込み待機時間の追加（1 秒）で空ファイル問題に対処

- ファイルパス解決ロジックの刷新

  - 絶対パスから相対パスへの変換機能を追加
  - パス形式の正規化（Windows/Unix パス対応）
  - ワークスペースルートからの相対パス変換による一貫性確保

- JSON 処理のエラー耐性強化

  - 詳細なエラーログの追加
  - JSON 構造の事前検証
  - データの存在確認強化

- テスト結果マッピングの精度向上
  - `fullName` または `title` を使用したテスト名の正確な抽出
  - ファイルパスとテスト名を組み合わせたユニークなキー生成
  - テスト結果保存時の詳細ログ追加によるデバッグ容易性向上

## 2023.5.15

### 現在成功している手法：テスト結果ファイル出力と読み込み

現在実装されている仕組みは以下のステップで正常に動作しています：

1. **テスト結果の出力**

   - Jest の`--outputFile`オプションを使用して JSON 形式のテスト結果を一時ファイルに出力
   - 一時ディレクトリに`jest-results-{timestamp}.json`形式でファイルを生成
   - 各テスト実行ごとに新しいファイルを作成（重複の心配なし）

2. **ファイルからの結果読み込み**

   - ファイル生成の完了を待機（最大 20 回の試行）
   - ファイル内容を読み込み、JSON としてパース
   - ファイルパスの正規化処理による絶対パス・相対パス対応
   - 複数のキー形式でテスト結果を保存（検索の冗長性確保）

3. **UI 更新の連携**
   - テストセッション終了時にテスト結果表示を更新
   - ファイル読み込みエラー時は標準出力パースにフォールバック
   - 詳細なログによるデバッグ容易性

### 今後の実装予定：テスト結果履歴管理

テスト結果ファイルの蓄積問題に対処するための改善案：

1. **履歴ファイルシステムの導入**

   - `.vscode/.jest-test-selector-history.json`に永続的な履歴ファイルを作成
   - 各テスト実行結果を履歴ファイルにマージして保存
   - テスト名、ファイルパス、成功/失敗状態、タイムスタンプを記録

2. **一時ファイル管理の改善**

   - テスト実行後の一時ファイル自動削除機能の追加
   - 古い一時ファイルの定期的なクリーンアップ処理
   - エラー発生時の一時ファイル保持オプション（デバッグ用）

3. **ユーザー設定オプションの追加**
   - 履歴保持期間の設定（デフォルト：30 日）
   - 履歴ファイルの最大サイズ制限
   - 履歴のエクスポート/インポート機能

これらの改善により、テスト結果の履歴を保持しながらもディスク使用量を抑制し、テスト実行結果の追跡性を向上させることが可能になります。テストエクスプローラーは常に履歴ファイルから結果を読み込むため、VSCode 再起動後も前回のテスト結果を表示できるようになります。

## 2023.5.16

### テスト結果履歴管理機能の実装

テスト結果の履歴管理機能を実装し、一時ファイルの蓄積問題を解決しました：

1. **履歴ファイルシステムの導入**

   - `.vscode/.jest-test-selector-history.json`に結果を永続的に保存
   - JSON ファイル形式での階層的データ構造を採用
     ```json
     {
       "testResults": {
         "ファイルパス1": {
           "テスト名1": { "status": "success", "timestamp": 1620000000000 },
           "テスト名2": { "status": "failure", "timestamp": 1620000000000, "message": "エラー内容" }
         },
         "ファイルパス2": { ... }
       },
       "lastUpdated": 1620000000000
     }
     ```
   - 既存の履歴との自動マージ機能

2. **一時ファイル管理の実装**

   - テスト実行後に一時ファイルを自動的に削除
   - 30 日以上経過した古いテスト結果の自動クリーンアップ

3. **VSCode 再起動時の状態保持**

   - 拡張機能起動時に自動的に履歴ファイルを読み込み
   - 前回のテスト結果を UI 上に表示

4. **パフォーマンス最適化**
   - 履歴データのインデックス化による高速検索
   - 必要に応じた増分保存による効率化

これらの機能により、テスト結果の永続的な管理が可能になり、VSCode の再起動後も前回のテスト結果を参照できるようになりました。また、履歴ファイル使用によりディスク使用量の抑制と、一時ファイルの自動削除による不要ファイルの蓄積防止を実現しています。

## 2024-06-09: 履歴ファイルのマージログ追加

履歴ファイルへのテスト結果マージ処理の可視性を向上させるため、以下のログを追加しました：

1. マージ前の既存履歴ファイルのテスト結果数をカウントして表示
2. 現在のテスト結果数を表示
3. マージ処理中に新規追加されたテストと更新されたテストの件数をカウントして表示
4. マージ結果のサマリーを表示（新規追加件数、更新件数）
5. マージ前と後の総テスト結果件数の変化を表示

これにより、テスト結果の保存処理がどのように行われているか、特にマージによる変更内容が明確になります。
またファイルパス単位で新しいファイルが追加された場合にもログを出力するようにしました。

## 2024-06-09: 不要なログ出力の削除

正常動作の確認ができたため、冗長なログ出力を削除しました。特に以下の箇所のログを整理し、出力を最小限に抑えました：

1. `JestDebugger.getTestResult`メソッド - テスト結果検索時の詳細なログを削除
2. `TestTreeItem.setTestCaseIcon`メソッド - アイコン設定時のデバッグログを削除
3. `TestTreeDataProvider`クラス - イベント受信時のログを削除

これにより、コンソール出力がスッキリとし、実際のエラーや重要な情報を見やすくなりました。必要なデバッグ情報（エラー状態やファイル読み込み失敗時のログなど）は維持しています。

### 履歴ファイル関連ログの追加

履歴機能の動作確認を容易にするため、以下の箇所に履歴ファイル関連のログを追加しました：

1. `initHistoryFilePath`メソッド - 履歴ファイルのパスをログ出力
2. `loadHistoryFile`メソッド - 履歴ファイルの存在確認、読み込み状況のログ出力
3. `saveTestResultsToHistory`メソッド - 保存開始と保存件数のログ出力

これらのログにより、履歴ファイルが正しく生成・読み込み・保存されているかを確認できます。特に以下の情報が分かるようになりました：

- 履歴ファイルの正確なパス
- 履歴ファイルが見つかったかどうか
- 履歴ファイルからの読み込み成功/失敗状況
- 読み込まれたテスト結果の件数
- 保存されたテスト結果の件数

## 2023/07/05

- JestDebugger クラスのコンパイルエラーを修正しました
  - 不足していた以下のメソッドを追加
    - `readTestResultsFromFile`: JSON 形式のテスト結果ファイルを読み込むメソッド
    - `setupTerminalOutputCapture`: ターミナル出力をキャプチャするためのセットアップメソッド
    - `monitorDebugOutput`: デバッグ出力のモニタリングメソッド
    - `escapeRegExp`: 正規表現のための文字列エスケープメソッド
    - `getJestCliArgs`: Jest CLI 引数の生成メソッド
    - `startDebuggingWithCustomCommand`: カスタムコマンドでのデバッグ開始メソッド
    - `prepareDirectoryTestCommand`: ディレクトリテスト用コマンド準備メソッド
    - `startDebuggingDirectoryTests`: ディレクトリ内テスト実行メソッド
  - `testCase`変数の参照エラーを修正
    - `startDebuggingAllTests`メソッド内の不要な`testCase`参照をコメントアウト
    - デバッグ設定名を適切な値に修正

## 2024-06-11: テスト結果一時ファイルのマージタイミング改善

テスト結果ファイルのマージプロセスに関する問題を修正しました:

1. **デバッグセッション終了処理の改善**

   - テスト終了の検出時にテスト結果の処理を確実に行うよう変更
   - `endDebugSession` メソッドを強化し、一時ファイルの読み込み完了後に履歴ファイルへのマージを実行
   - 成功時の処理フローを明確化（読み込み → マージ → 一時ファイル削除）

2. **デバッグセッション終了イベントの処理改善**

   - Jest デバッグセッションの明示的な検出（セッション名による識別）
   - デバッグセッション終了後に十分な待機時間を追加（2 秒）して確実にファイル書き込みが完了するのを待機
   - タイムアウト時間を 30 秒から 60 秒に延長

3. **一時ファイル管理の確実な実行**
   - テスト結果読み込み後に必ず一時ファイルを削除するよう処理順序を修正
   - エラー発生時でも後続の処理が継続されるよう例外処理を改善

この変更により、テスト実行後のファイル処理が以下の順序で確実に実行されるようになりました:

1. テスト終了を検出
2. 一時ファイルからテスト結果を読み込み
3. 履歴ファイルに結果をマージ
4. 一時ファイルを削除

また、タイミングの問題を回避するために適切な待機時間を導入し、より確実にファイル処理が行われるようになりました。

## 2024-06-12: テスト結果出力ファイルの自動生成機能を追加

テスト結果ファイルの生成と処理に関する問題を解決するため、以下の機能を追加・改良しました:

1. **テスト結果一時ファイルの自動生成**

   - `generateJsonOutputFilePath` メソッドを新規作成し、一時ディレクトリにユニークなファイル名を生成
   - テスト開始時に自動的に一時ファイルパスを設定し、`jsonOutputFilePath` 変数に保存
   - 各テスト実行ごとに新しいファイルパスを生成することで競合を防止

2. **Jest コマンドの引数に出力ファイルオプションを追加**

   - `getJestCliArgs` メソッドを修正し、`--outputFile` オプションを常に追加するよう変更
   - コマンドライン引数に重複が発生しないよう制御を追加
   - 既存のオプションセットに `--outputFile` が含まれる場合は上書きするロジックを追加

3. **ディレクトリテスト実行コマンドの対応**
   - `prepareDirectoryTestCommand` メソッドも修正し、コマンド生成時に出力ファイルオプションを追加
   - 引数フィルタリング機能を追加して重複を防止

この変更により、すべてのテスト実行パターン（ファイル単位、テストケース単位、ディレクトリ単位）で確実にテスト結果ファイルが生成され、テスト終了時に適切に処理されるようになりました。出力ファイルパスがコンソールに表示されるため、デバッグ時の追跡も容易になっています。

## 2024-06-13: テスト履歴と一時ファイルの保存先を統合

テスト関連ファイルの管理を改善するため、保存先ディレクトリ構造を変更しました:

1. **専用ディレクトリの導入**

   - ワークスペースのルートに `.jest-test-selector` ディレクトリを作成し、すべてのテスト関連ファイルを集約
   - 従来の `.vscode` ディレクトリ内ではなく、専用ディレクトリで管理することでクリーンな構造を実現
   - ディレクトリ構造の一貫性を確保し、テスト関連ファイルの探索を容易に

2. **履歴ファイルの移行**

   - 履歴ファイル名を `.jest-test-selector-history.json` から `history.json` にシンプル化
   - 初回実行時に自動的に新しいディレクトリ構造に移行

3. **テスト結果一時ファイルの保存先変更**
   - 以前はシステムの一時ディレクトリに保存していた一時ファイルを同じディレクトリ内に配置
   - `generateJsonOutputFilePath` メソッドを修正し、統一されたディレクトリを使用
   - ディレクトリが存在しない場合のフォールバックとしてシステム一時ディレクトリを維持

この変更により、テスト履歴と一時ファイルが同じ場所で管理されるようになり、ファイル操作の整合性と管理のしやすさが向上しました。また、一時ファイルを含むすべてのテスト関連ファイルが単一のディレクトリにまとめられ、クリーンアップが容易になりました。

## 2024-06-14: システム一時ディレクトリ内にサブディレクトリを作成

一時ファイルの管理を改善するため、システム一時ディレクトリ内の構造を変更しました:

1. **専用サブディレクトリの作成**

   - システム一時ディレクトリ内に `jest-test-selecter` サブディレクトリを作成
   - 一時ファイルをサブディレクトリ内に配置することで整理整頓
   - 一時ファイルが他のアプリケーションの一時ファイルと混在するのを防止

2. **ディレクトリ作成エラー処理の強化**
   - サブディレクトリ作成に失敗した場合のフォールバック処理を追加
   - エラーログの出力による診断情報の提供
   - サブディレクトリ作成成功時の通知ログを追加

この変更により、以下の保存先パスとなりました:

- `.jest-test-selector/history.json` - ワークスペースルート内の履歴ファイル
- `.jest-test-selector/jest-results-{timestamp}.json` - ワークスペースルート内の一時ファイル
- `{tmpdir}/jest-test-selecter/jest-results-{timestamp}.json` - フォールバック用の一時ファイル（システム一時ディレクトリ内）

サブディレクトリ化によって、システム一時ディレクトリ内の整理が向上し、拡張機能による一時ファイルが明確に識別できるようになりました。また、複数のプロジェクトで拡張機能を使用する場合でも、システム一時ディレクトリ内で一覧性が確保されます。

## 2024-06-15: テスト結果の一時ファイル保存先を統一

テスト結果の一時ファイル保存先を統一し、常に OS の一時ディレクトリを使用するように変更しました:

1. **一時ファイル保存先の統一**

   - 常にシステム一時ディレクトリ内の `jest-test-selecter` サブディレクトリを使用
   - ワークスペースルート内の `.jest-test-selector` ディレクトリは履歴ファイルのみに使用
   - 一時ファイルとテスト結果履歴ファイルの保存場所を明確に分離

2. **ファイルパス生成処理の簡素化**
   - 条件分岐を削除し、常に同じロジックで一時ファイルパスを生成
   - ファイルパスをコンソールに表示して追跡を容易に
   - 一貫した命名規則によるファイル管理の向上

この変更により、すべてのプロジェクトでテスト結果の一時ファイルは以下のパスに保存されます:

- `{tmpdir}/jest-test-selecter/jest-results-{timestamp}.json`

これにより、複数のプロジェクトでの競合を避けつつ、統一された場所で一時ファイルを管理できるようになりました。履歴ファイルはプロジェクトごとに個別のディレクトリに保存され、一時ファイルは共通の場所に保存される設計になっています。

## 2024-06-16: テスト履歴ファイルの保存先を一時ディレクトリに変更

テスト履歴ファイルの保存先を OS の一時ディレクトリに変更し、テスト結果一時ファイルと同じ場所で管理するように改善しました:

1. **履歴ファイルの保存先変更**

   - ワークスペースルート内の `.jest-test-selector` ディレクトリではなく、OS の一時ディレクトリ内の `jest-test-selecter` サブディレクトリを使用
   - 一時ファイル（テスト結果 JSON）と履歴ファイル（history.json）を同じディレクトリで管理
   - マルチプロジェクト環境でも一貫した場所で全てのファイルを管理

2. **ディレクトリ初期化処理の統合**
   - 履歴ディレクトリと一時ファイルディレクトリを統合し、同じ場所を参照
   - `initHistoryFilePath` メソッドと `generateJsonOutputFilePath` メソッドの連携強化
   - エラー処理の改善とフォールバックメカニズムの統合

この変更により、すべてのファイルは以下のディレクトリに統一して保存されるようになりました:

- `{tmpdir}/jest-test-selecter/`
  - `history.json` - テスト結果の履歴ファイル
  - `jest-results-{timestamp}.json` - テスト実行時の一時結果ファイル

これにより、OS 標準の一時ディレクトリに全てのファイルが保存され、プロジェクト間での一貫性が向上しました。また、システムの一時ファイルクリーンアップ機能との親和性も高まりました。

## 2024-06-16: スキップされたテストをマージから除外する機能追加

テスト結果の管理を改善し、スキップされたテストを履歴ファイルにマージしないように変更しました:

1. **スキップされたテストの識別機能**

   - `TestResultStatus` enum に `Skipped` 型を追加
   - Jest 出力のパターンマッチングを拡張してスキップされたテストを検出
   - `skipped`、`pending`、`disabled` などのステータスを持つテストをスキップ扱いに統一

2. **マージ処理の改善**

   - スキップされたテスト（`TestResultStatus.Skipped`）をマージから除外
   - 不明なステータス（`TestResultStatus.Unknown`）も同様に除外
   - マージ除外時にログ出力を追加して追跡を容易に

3. **テキスト出力パターン検出の強化**
   - ⚠ 警告マーク、SKIP キーワードなど、様々な Jest 出力形式に対応
   - 正規表現パターンを追加して幅広いテスト出力形式をサポート

この変更により、テスト履歴には成功または失敗したテストのみが保存され、一時的にスキップされたテストは履歴に残らなくなりました。これにより履歴データの品質が向上し、重要なテスト結果のみが保存されるようになりました。

## 2023-XX-XX pending ステータスの追加

- 問題: JSON には「pending」というステータスが記録されているが、マージ処理時に「success」に変更されていた
- 解決策:
  - TestResultStatus タイプに「Pending」ステータスを追加
  - マージ処理で pending ステータスを適切に処理するよう修正
  - TestTreeItem の setTestCaseIcon 関数に Pending ステータスの表示方法を追加
- 結果: pending ステータスが適切に処理され、保留中のテストとして表示されるようになりました

## 2024 年 XX 月 XX 日：コマンドライン引数の重複問題を修正

### 問題の概要

Jest テスト実行時に `argv.config.match is not a function` というエラーが発生していました。これは実行コマンドに以下のような問題があったためです：

1. `--config jest.config.js` が重複して指定されていた
2. `--outputFile` のパスが重複して指定されていた
3. 同じファイルパスが複数回指定されていた

### 修正内容

以下の 2 つのメソッドを修正して重複引数を排除しました：

1. `prepareDirectoryTestCommand`：

   - `cliArgs` の代わりに、`savedOptions` から直接フィルタリングして引数を生成
   - `--config`, `--outputFile`, `--json` などのオプションが重複しないように処理

2. `getJestCliArgs`：
   - `--config` と `--outputFile` オプションを除外するロジックを追加
   - 他のメソッドで必須引数として追加しているものと重複しないよう改善

これにより、Jest 実行時のコマンドライン引数の重複が解消され、正常にテストが実行できるようになりました。

## 2024-06-20

### ディレクトリテスト実行時のユニットテスト後に E2E テストを連続実行するように修正

`startDebuggingDirectoryTests` メソッドを修正し、`testMode` が "all" の場合に、ユニットテストが完了した後に E2E テストを自動的に実行するようにしました。

変更前は `&&` でコマンドを連結していましたが、VSCode のデバッグセッションでは正確な実行順序が制御できない場合があるため、`onDidTerminateDebugSession` イベントリスナーを使用して、最初のセッション終了後に次のセッションを開始する方式に変更しました。

これにより、ユニットテストが完了した後、正確に E2E テストが実行されるようになりました。

## 2023.5.17

### テスト実行失敗の問題を修正

- `startDebuggingDirectoryTests`メソッドのバグを修正
  - `else`ブロックが空だったため、`unit`モードと`e2e`モードでテスト実行が失敗していた問題を修正
  - 適切なコマンド実行処理を追加（`unit`モードと`e2e`モード用）
  - タスク名を適切に設定（「ユニットテスト」または「E2E テスト」）

修正内容：

```typescript
// unit または e2e モードの場合は直接実行
const taskName = `${dirName} - ${
  testMode === "unit" ? "ユニットテスト" : "E2Eテスト"
}`;
return await this.startDebuggingWithCustomCommand(
  packageInfo.path,
  packageInfo,
  command,
  taskName
);
```

これにより、`unit`モードと`e2e`モード両方でテストが正常に実行できるようになりました。

## 2023.6.15

### --outputFile オプション重複問題の修正

- `--outputFile`オプションが重複して指定されるバグを修正

  - `getJestCliArgs`メソッドで`--outputFile`オプションをユーザーが指定している場合は追加しないよう変更
  - `prepareDirectoryTestCommand`メソッドで二重に`--outputFile`オプションを追加していた問題を修正
  - 類似エラー: `TypeError [ERR_INVALID_ARG_TYPE]: The "path" argument must be of type string. Received an instance of Array`

- 二重指定の原因

  - `getJestCliArgs`メソッドで常に`--outputFile`オプションを追加
  - `prepareDirectoryTestCommand`メソッドでさらに`--outputFile`オプションを追加
  - その結果、Jest が`--outputFile`を配列として受け取り、`path.resolve()`で型エラーが発生

- 修正方法
  1. ユーザーが明示的に`--outputFile`を指定している場合は自動追加しないよう条件分岐を追加
  2. `prepareDirectoryTestCommand`メソッドでの重複追加を削除
  3. 適切なエラー処理と冗長性を確保
