# 対応履歴

## 2023/05/15

### テストエクスプローラーのファイルノードに実行アイコンを追加

- テストエクスプローラーのファイルノードごとに表示されていた「All Tests」ノードを削除
- 代わりに、ファイルノード自体にテスト実行アイコンを追加
- パッケージノードと同様の方法で、ファイルノードにホバーで表示される実行アイコンを実装
- ファイルノードのコンテキスト値に `runnableTestFile` を追加し、実行アイコンが表示されるように修正

この変更により、テストエクスプローラーの UI/UX が改善され、より直感的な操作が可能になりました。

### テスト実行アイコンの表示位置を修正

- テスト実行アイコンがディレクトリノードにも表示されてしまう問題を修正
- package.json の when 条件を変更し、runFileAllTests コマンドが表示される条件を`runnableTestFile`コンテキスト値を持つノードのみに限定
- これにより、テスト実行アイコンが適切なファイルノードにのみ表示されるようになりました

### ファイル名ノードにアイコンが表示されない問題を修正

- ディレクトリ表示時にテストファイルが`"describe"`タイプとして作成されていたため、実行アイコンが表示されない問題を修正
- ディレクトリ表示時のテストファイルノードのタイプを`"file"`に統一
- package.json の when 条件を正規表現を用いた形式に拡張し、複合コンテキスト値を持つノードにもアイコンが表示されるように修正
- これにより、すべてのファイルノードに実行アイコンが表示されるようになりました

# 機能対応メモ

## 2023-XX-XX ファイルノードのテスト結果に基づくアイコン表示機能の追加

ツリービューにおいてファイルノードのアイコン表示を改善しました。ファイル内のテスト結果に基づいて、以下のようにアイコンが変化するようになりました：

1. すべてのテストが成功（TestResultStatus.Success）している場合：

   - 緑色のチェックマークアイコンを表示
   - ツールチップに「すべてのテスト成功」と表示

2. 失敗したテスト（TestResultStatus.Failure）がある場合：

   - 赤色のバツ印アイコンを表示
   - ツールチップに「テスト失敗あり」と表示

3. テスト結果がない、または実行中・保留中の場合：
   - 通常のフォルダアイコンを表示

対応内容:

1. TestTreeItem クラスに`checkFileTestStatus()`メソッドを追加し、テスト結果のステータスを返すよう実装
2. ファイルタイプの処理で条件分岐を追加し、テスト結果に基づいてアイコンを切り替えるよう実装
3. テスト結果に応じたアイコンとツールチップのテキストを設定

これにより、テスト結果の視認性が向上し、一目でファイル内のテスト全体の状況が把握できるようになりました。特に、複数のテストファイルがある場合に、どのファイルに問題があるかを素早く確認できます。

# 問題修正記録

## 2024-07-04 testCase 名のエスケープ問題を修正

### 問題

`debugger.ts`内の`createTestCommand`メソッドで、テストケース名を指定する際に空白文字を`\\ `でエスケープしていましたが、これが Jest コマンドライン引数エラーの原因となっていました：

```
● Unrecognized CLI Parameter:
  Unrecognized option "\\".
```

### 修正内容

- テストケース名を指定する際に、空白文字をエスケープする処理を削除
- 単に引用符で囲むことで正しく処理されるようにしました
- その後、テスト名の末尾に$記号を追加し、正規表現によるサフィックス一致を可能に

変更ファイル：`src/debugger.ts`

## 2023-xx-xx Jest テスト実行時のコマンドライン引数の問題を修正

`originalStartDebugging`メソッドでテストを実行すると、引数の解析に問題があり正しく実行できない状態でした。

### 問題点

- `createTestCommand`メソッドで配列要素に空白を含む形で引数が作成されていた
- 生成された引数にバックスラッシュ(`\`)が混入し、Jest が正しく解析できなくなっていた

### 修正内容

- 各引数を個別の配列要素として追加するよう変更
- 条件分岐の可読性を向上させるために if 文に変更
- 正規表現パターンのエスケープを適切に追加
- ログを改善して、生成されたコマンドを確認しやすく

これにより、特定のテストケースや E2E テストなどを正しく実行できるようになりました。

## 2024-xx-xx スキップされたテストが実行できない問題を修正

### 問題

テストコマンドの引数は正しく解析されるようになりましたが、テストコード内で`test.skip`や`it.skip`として定義されたテストは、明示的に指定してもスキップされてしまう問題がありました。

### 修正内容

- `createTestCommand`メソッドに`--no-skip`オプションを追加し、スキップ指定されたテストも強制的に実行できるようにしました
- ファイルパスとテスト名パターンを同時に指定する場合は`--runTestsByPath`フラグを追加
- 実行失敗を防ぐために`--no-passWithNoTests`と`--forceExit`オプションも追加

これにより、テストコード内でスキップマークが付いていても、明示的に指定したテストケースを実行できるようになりました。
